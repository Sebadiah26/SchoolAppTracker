@page "{id:int}"
@model SchoolAppTracker.Pages.Apps.DetailsModel
@using SchoolAppTracker.Data.Data
@{
    ViewData["Title"] = "Application Details";
}

<h1>@Model.Application.Name</h1>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header"><strong>General Information</strong></div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Description</dt>
                    <dd class="col-sm-8">@(Model.Application.Description ?? "N/A")</dd>
                    <dt class="col-sm-4">Vendor</dt>
                    <dd class="col-sm-8">@(Model.Application.VendorName ?? "N/A")</dd>
                    <dt class="col-sm-4">Vendor Contact</dt>
                    <dd class="col-sm-8">@(Model.Application.VendorContact ?? "N/A")</dd>
                    <dt class="col-sm-4">Website</dt>
                    <dd class="col-sm-8">
                        @if (!string.IsNullOrEmpty(Model.Application.WebsiteUrl))
                        {
                            <a href="@Model.Application.WebsiteUrl" target="_blank">@Model.Application.WebsiteUrl</a>
                        }
                        else
                        {
                            <text>N/A</text>
                        }
                    </dd>
                    <dt class="col-sm-4">Category</dt>
                    <dd class="col-sm-8">@(Model.Application.Category?.Name ?? "N/A")</dd>
                    <dt class="col-sm-4">Status</dt>
                    <dd class="col-sm-8">
                        <span class="badge @(Model.Application.Status switch
                        {
                            AppStatus.Active => "bg-success",
                            AppStatus.Inactive => "bg-secondary",
                            AppStatus.UnderReview => "bg-warning text-dark",
                            AppStatus.Deprecated => "bg-danger",
                            _ => "bg-light text-dark"
                        })">@Model.Application.Status</span>
                    </dd>
                    <dt class="col-sm-4">Approval Status</dt>
                    <dd class="col-sm-8">
                        <span class="badge @(Model.Application.ApprovalStatus switch
                        {
                            ApprovalStatus.Approved => "bg-success",
                            ApprovalStatus.Pending => "bg-warning text-dark",
                            ApprovalStatus.Denied => "bg-danger",
                            _ => "bg-light text-dark"
                        })">@Model.Application.ApprovalStatus</span>
                    </dd>
                    <dt class="col-sm-4">Approved By</dt>
                    <dd class="col-sm-8">@(Model.Application.ApprovedBy ?? "N/A")</dd>
                    <dt class="col-sm-4">Approved Date</dt>
                    <dd class="col-sm-8">@(Model.Application.ApprovedDate?.ToString("MM/dd/yyyy") ?? "N/A")</dd>
                </dl>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header"><strong>Rostering</strong></div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Rostering Method</dt>
                    <dd class="col-sm-8">@Model.Application.RosteringMethod</dd>
                </dl>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header"><strong>Compliance & SSO</strong></div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">SSO Enabled</dt>
                    <dd class="col-sm-8">@(Model.Application.SsoEnabled ? "Yes" : "No")</dd>
                    <dt class="col-sm-4">SSO Provider</dt>
                    <dd class="col-sm-8">@(Model.Application.SsoProvider ?? "N/A")</dd>
                    <dt class="col-sm-4">FERPA Compliant</dt>
                    <dd class="col-sm-8">@(Model.Application.FerpaCompliant ? "Yes" : "No")</dd>
                    <dt class="col-sm-4">COPPA Compliant</dt>
                    <dd class="col-sm-8">@(Model.Application.CoppaCompliant ? "Yes" : "No")</dd>
                    <dt class="col-sm-4">Data Privacy Agreement</dt>
                    <dd class="col-sm-8">
                        @if (!string.IsNullOrEmpty(Model.Application.DataPrivacyAgreementUrl))
                        {
                            <a href="@Model.Application.DataPrivacyAgreementUrl" target="_blank">View Agreement</a>
                        }
                        else
                        {
                            <text>N/A</text>
                        }
                    </dd>
                </dl>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header"><strong>Contract & Licensing</strong></div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Contract Start</dt>
                    <dd class="col-sm-8">@(Model.Application.ContractStartDate?.ToString("MM/dd/yyyy") ?? "N/A")</dd>
                    <dt class="col-sm-4">Contract End</dt>
                    <dd class="col-sm-8">@(Model.Application.ContractEndDate?.ToString("MM/dd/yyyy") ?? "N/A")</dd>
                    <dt class="col-sm-4">Annual Cost</dt>
                    <dd class="col-sm-8">@(Model.Application.AnnualCost?.ToString("C") ?? "N/A")</dd>
                    <dt class="col-sm-4">License Type</dt>
                    <dd class="col-sm-8">@(Model.Application.LicenseType ?? "N/A")</dd>
                    <dt class="col-sm-4">Number of Licenses</dt>
                    <dd class="col-sm-8">@(Model.Application.NumberOfLicenses?.ToString() ?? "N/A")</dd>
                </dl>
            </div>
        </div>

        @if (Model.Application.ApplicationDepartments.Any())
        {
            <div class="card mb-3">
                <div class="card-header"><strong>Departments</strong></div>
                <div class="card-body">
                    @foreach (var dept in Model.Application.ApplicationDepartments)
                    {
                        <span class="badge bg-info me-1">@dept.Department.Name</span>
                    }
                </div>
            </div>
        }

        @if (Model.Application.ApplicationGradeLevels.Any())
        {
            <div class="card mb-3">
                <div class="card-header"><strong>Grade Levels</strong></div>
                <div class="card-body">
                    @foreach (var gl in Model.Application.ApplicationGradeLevels)
                    {
                        <span class="badge bg-info me-1">@gl.GradeLevel.Name</span>
                    }
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.Application.Notes))
        {
            <div class="card mb-3">
                <div class="card-header"><strong>Notes</strong></div>
                <div class="card-body">@Model.Application.Notes</div>
            </div>
        }
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Screenshots</strong>
                <span class="badge bg-secondary">@Model.Application.Screenshots.Count</span>
            </div>
            <div class="card-body">
                @if (Model.Application.Screenshots.Any())
                {
                    <div class="row">
                        @foreach (var screenshot in Model.Application.Screenshots)
                        {
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#screenshotModal" onclick="document.getElementById('modalImage').src='@screenshot.FilePath'; document.getElementById('modalLabel').textContent='@screenshot.FileName';">
                                        <img src="@screenshot.FilePath" class="card-img-top" alt="@screenshot.FileName" style="cursor:pointer;" />
                                    </a>
                                    <div class="card-body p-2">
                                        <small class="text-muted">@screenshot.FileName (@(screenshot.FileSize / 1024) KB)</small>
                                        <form method="post" asp-page-handler="DeleteScreenshot" asp-route-id="@Model.Application.ID" class="mt-1">
                                            <input type="hidden" name="screenshotId" value="@screenshot.ID" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted mb-0">No screenshots uploaded yet.</p>
                }

                <hr />
                <form method="post" asp-page-handler="Upload" asp-route-id="@Model.Application.ID" enctype="multipart/form-data">
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            <label class="form-label">Upload Screenshot</label>
                            <input type="file" name="ScreenshotUpload" class="form-control" accept="image/jpeg,image/png,image/gif,image/webp" />
                            <small class="text-muted">Max 5MB. JPEG, PNG, GIF, or WebP.</small>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-success">Upload</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <a asp-page="/Apps/Edit" asp-route-id="@Model.Application.ID" class="btn btn-primary">Edit</a>
    <a asp-page="/Apps/Delete" asp-route-id="@Model.Application.ID" class="btn btn-danger">Delete</a>
    <a asp-page="/Apps/Index" class="btn btn-outline-secondary">Back to List</a>
</div>

<div class="modal fade" id="screenshotModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="Screenshot" />
            </div>
        </div>
    </div>
</div>
